# User Uploads


## for the cellxgene Data Portal

**Authors:** [Trent Smith](mailto:trent.smith@chanzuckerberg.com)

**Approvers:** [Friendly Tech Person](mailto:some.nice.person@chanzuckerberg.com), [Friendly PM Person](mailto:some.nice.person@chanzuckerberg.com), [Friendly Tech Person2](mailto:some.nice.person@chanzuckerberg.com), [Girish Patangay](mailto:girish.patangay@chanzuckerberg.com), [Sara Gerber](mailto:sara.gerber@chanzuckerberg.com)

## tl;dr

A user can upload files of any size to Data Portal using either a shared link from their cloud provider, or directly from their browser.

## Glossary

- CSP(Cloud Storage Provider) - Cloud storage services such as Dropbox or Google Drive.
- Shared Link - A link from a CSP that give the bearer of that link access to private data.
- DP(Data Portal) - The cellxgene Data Portal
- NF(non-functional) - refers to a non functional requirement.
- F(functional requirement) - refers to a functional requirement
## Problem Statement | Background

One of the primary goals of the DP is to allow users to upload their own dataset. These data set can vary in
size from a few MB to several GB. User may want to upload from their local machine or from their CSP. For
user that want to upload from their local machine, they must be able to resume an upload in the event their connection
is interrupted. For users that want to upload data sets from their CSP, they are able to provide a shared link from
their CSP that we can used to upload directly to our storage.

## Product Requirements

1. A user can upload a file to DP using a shared link from their CSP.
1. A user can upload a file from their local machine using the DP browser.
1. A user can resume an upload with out completely restarting.


### Nonfunctional requirements
Nonfunctional requirements are not directly related to the user story but may instead reflect some technical aspect of the implementation, such as latency. [Here's](https://en.wikipedia.org/wiki/Non-functional_requirement) a more comprehensive list of nonfunctional requirements.


1. NF: Cloud to Cloud uploads will retry if they fail.
1. NF: A user can upload a single file up to 30GB in size.

## Detailed Design | Architecture | Implementation

### Cloud to Cloud
Cloud to cloud uploads will allow a user to provide a sharable link from their CSP to the file they wish to upload,
which DP will used to upload the file to our S3 bucket. Now to walk though the cloud to cloud flow, see figure 1.

![Cloud to Cloud](https://app.lucidchart.com/publicSegments/view/e1e72143-c108-4c7f-bf6c-053d98256c1f/image.png)
**Figure 1:** Architecture of a user uploading from their cloud to our cloud.

#### 1. Get Share Link
The user will generate a sharable link from their CSP. Both Google Drive and Dropbox support the generation of
sharable links. Only sharable links should only point to a single file, not a folder or collection of files.

#### 2. Share Link
The user will make a request to upload the file by providing the sharable link in the request body.

##### POST {collection_id}/{dataset_id}/upload/link
The body will contain the link to the file.

#### 3. Sanitize
To prevent [server side request forgery](https://owasp.org/www-community/attacks/Server_Side_Request_Forgery) the
incoming shared link will be sanitized before queuing for download. The links generated by CSP are often not direct
links to the files and often need to be parsed into the correct shape for downloading. The correct URL will be generated
as part of sanitization.

##### How to download from a shared link
- Dropbox https://help.dropbox.com/files-folders/share/force-download
- Google drive https://www.labnol.org/internet/direct-links-for-google-drive/28356/

#### 4. _Optional_ Queue
This part is optional and depends on load we expect and server type we select. The queue stores the links that need to
be processed. It buffers the down stream servers from download requests. This allows us to spin up servers as needed.
It also gives us the ability to retry a download if one of servers fails to download or upload the file.

##### Why might the download fail?
- The server downloading ran out of space.
- The CSP experience and outage
- The user has reached their daily bandwidth allowance from their CSP. [more info](https://help.dropbox.com/files-folders/share/banned-links)

#### Download Job Entry
These are the fields that will be in the download job placed in the queue
- Link
- collect_id
- dataset_id
- file_id
- file size
- file name

#### 5. Start EC2 Instance to Download File
We will need to spin up EC2 instances with enough storage to download the whole file. TODO: See if spot instances could be used.

#### 6. Download the File
The most time will be spent here, downloading the file.

#### 7. Upload to S3
If the file is >5GB in size we can upload the file directly to s3 without writing to disk. For files <5GB, the file must
 be completely downloaded before it can be uploaded to s3. The AWS SDK will be used to upload large files in parts.
 Once upload is complete, and the download job will be removed from the queue.

> ??? Do we need to tell the the user or the DB when the file is done do uploading. This makes me think we need an endpoint
finalize the upload. The endpoint will look for the expected file, and if it's found, update the database with the file
info.

### Local to Cloud

![Local to Cloud](https://app.lucidchart.com/publicSegments/view/80361b71-5317-478b-921e-0ead5152c865/image.png)
**Figure 2:** Architecture of a user uploading from their local machine to our cloud.

### [Optional] Data model

This section details anything from database schemas, to filesystem structures, to storage formats. Anything that "persists", is accessed by multiple component, or is something that could cause upgrade issues upon change, should belong in this section.


### [Optional] Test plan

This section details the sorts of tests that will be written to give confidence that the implementation matches the design. Enumerating the test cases is a good way to find holes in the design and helps the reviewers understand, in more detail, how the feature works. It also helps get into the mindset of test driven development.


### [Optional] Monitoring and error reporting

This section contains information on the monitoring and error reporting features that will be built in order for the system to respond and alert users on failures of the feature being designed. This helps ensure that failure modes are thought about and the users' experiences with facing errors is consistent and helpful, rather than frustrating.


## [Optional] Alternatives

Especially for larger designs, you probably considered more than one design so itâ€™s worthwhile to briefly list the others and a short note on why you decided against it.


## References

Any relevant documents or prior art should be clearly listed here. Any citation of figures or papers should also be clearly listed here. Of course, they can also be linked throughout the document when directly referenced.

1. [Image of random system architecture](https://www.visual-paradigm.com/features/aws-architecture-diagram-tool/).

1. [Google Developer Documentation Style Guide](https://developers.google.com/style/highlights#introduction_1)

1. [Architecture diagrams](https://app.lucidchart.com/invitations/accept/5c9d05ba-e372-4b10-aa69-e257686469da)
